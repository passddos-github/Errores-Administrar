package dev._2lstudios.exploitfixer.bukkit.commands;

import org.bukkit.command.Command;
import org.bukkit.command.CommandExecutor;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;

import dev._2lstudios.exploitfixer.bukkit.ExploitFixer;
import dev._2lstudios.exploitfixer.bukkit.managers.ExploitPlayerManager;
import dev._2lstudios.exploitfixer.bukkit.managers.ModuleManager;
import dev._2lstudios.exploitfixer.bukkit.modules.BukkitNotificationsModule;
import dev._2lstudios.exploitfixer.bukkit.utils.VersionUtil;
import dev._2lstudios.exploitfixer.shared.modules.MessagesModule;

public class ExploitFixerCommand implements CommandExecutor {
	private final ExploitFixer exploitFixer;
	private final MessagesModule messagesModule;
	private final BukkitNotificationsModule notificationsModule;
	private final ExploitPlayerManager exploitPlayerManager;

	public ExploitFixerCommand(final ExploitFixer exploitFixer, final ModuleManager moduleManager) {
		this.exploitFixer = exploitFixer;
		this.messagesModule = moduleManager.getMessagesModule();
		this.notificationsModule = moduleManager.getNotificationsModule();
		this.exploitPlayerManager = moduleManager.getExploitPlayerManager();
	}

	@Override
	public boolean onCommand(final CommandSender commandSender, final Command command, final String label,
			final String[] args) {
		final int length = args.length;
		final String lang;

		if (commandSender instanceof Player) {
			lang = VersionUtil.getLocale((Player) commandSender);
		} else {
			lang = "en";
		}

		if (length < 1 || args[0].equals("help")) {
			commandSender.sendMessage(messagesModule.getHelp(lang).replace("%command%", label));
		} else if (args[0].equals("reload"))
			if (commandSender.hasPermission("exploitfixer.admin")) {
				exploitFixer.reload();
				commandSender.sendMessage(messagesModule.getReload(lang));
			} else {
				commandSender.sendMessage(messagesModule.getPermission(lang));
			}
		else if (args[0].equals("stats"))
			if (commandSender.hasPermission("exploitfixer.admin"))
				commandSender.sendMessage(messagesModule.getStats(lang)
						.replace("%players_punished%", String.valueOf(exploitPlayerManager.getPunishments()))
						.replace("%players_cached%", String.valueOf(exploitPlayerManager.getSize())));
			else
				commandSender.sendMessage(messagesModule.getPermission(lang));
		else if (args[0].equalsIgnoreCase("notifications")) {
			if (commandSender instanceof Player) {
				if (commandSender.hasPermission("exploitfixer.admin")
						|| commandSender.hasPermission("exploitfixer.notifications")) {
					final String playerName = commandSender.getName();

					if (!notificationsModule.isNotifications(playerName)) {
						notificationsModule.setNotifications(playerName, true);
						commandSender.sendMessage(messagesModule.getEnable(lang));
					} else {
						notificationsModule.setNotifications(playerName, false);
						commandSender.sendMessage(messagesModule.getDisable(lang));
					}
				} else {
					commandSender.sendMessage(messagesModule.getPermission(lang));
				}
			} else {
				commandSender.sendMessage(messagesModule.getConsole(lang));
			}
		} else {
			commandSender.sendMessage(messagesModule.getUnknown(lang));
		}

		return true;
	}
}
