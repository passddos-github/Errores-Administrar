package dev._2lstudios.exploitfixer.bungee.commands;

import dev._2lstudios.exploitfixer.bungee.ExploitFixer;
import dev._2lstudios.exploitfixer.bungee.managers.ExploitPlayerManager;
import dev._2lstudios.exploitfixer.bungee.managers.ModuleManager;
import dev._2lstudios.exploitfixer.bungee.utils.VersionUtil;
import dev._2lstudios.exploitfixer.shared.modules.MessagesModule;
import dev._2lstudios.exploitfixer.shared.modules.NotificationsModule;
import net.md_5.bungee.api.CommandSender;
import net.md_5.bungee.api.chat.TextComponent;
import net.md_5.bungee.api.connection.ProxiedPlayer;
import net.md_5.bungee.api.plugin.Command;

public class ExploitFixerCommand extends Command {
	private final ExploitFixer exploitFixer;
	private final MessagesModule messagesModule;
	private final NotificationsModule notificationsVariables;
	private final ExploitPlayerManager exploitPlayerManager;

	public ExploitFixerCommand(final String string, final String[] aliases, final ExploitFixer exploitFixer,
			final ModuleManager moduleManager) {
		super(string, null, aliases);
		this.exploitFixer = exploitFixer;
		this.messagesModule = moduleManager.getMessagesModule();
		this.notificationsVariables = moduleManager.getNotificationsModule();
		this.exploitPlayerManager = moduleManager.getExploitPlayerManager();
	}

	@Override
	public void execute(final CommandSender commandSender, final String[] args) {
		String lang = "en";
		final int length = args.length;

		if (commandSender instanceof ProxiedPlayer) {
			lang = VersionUtil.getLocale((ProxiedPlayer) commandSender);
		}

		if (length < 1 || args[0].equals("help")) {
			commandSender.sendMessage(
					TextComponent.fromLegacyText(messagesModule.getHelp(lang).replace("%command%", "exploitfixer")));
		} else if (args[0].equals("reload"))
			if (commandSender.hasPermission("exploitfixer.admin")) {
				exploitFixer.reload();
				commandSender.sendMessage(TextComponent.fromLegacyText(messagesModule.getReload(lang)));
			} else
				commandSender.sendMessage(TextComponent.fromLegacyText(messagesModule.getPermission(lang)));
		else if (args[0].equals("stats"))
			if (commandSender.hasPermission("exploitfixer.admin"))
				commandSender.sendMessage(TextComponent.fromLegacyText(messagesModule.getStats(lang)
						.replace("%players_punished%", String.valueOf(exploitPlayerManager.getPunishments()))
						.replace("%players_cached%", String.valueOf(exploitPlayerManager.getSize()))));
			else
				commandSender.sendMessage(TextComponent.fromLegacyText(messagesModule.getPermission(lang)));
		else if (args[0].equalsIgnoreCase("notifications")) {
			if (commandSender instanceof ProxiedPlayer) {
				if (commandSender.hasPermission("exploitfixer.admin")
						|| commandSender.hasPermission("exploitfixer.notifications")) {
					final String playerName = commandSender.getName();

					if (!notificationsVariables.isNotifications(playerName)) {
						notificationsVariables.setNotifications(playerName, true);
						commandSender.sendMessage(TextComponent.fromLegacyText(messagesModule.getEnable(lang)));
					} else {
						notificationsVariables.setNotifications(playerName, false);
						commandSender.sendMessage(TextComponent.fromLegacyText(messagesModule.getDisable(lang)));
					}
				} else
					commandSender.sendMessage(TextComponent.fromLegacyText(messagesModule.getPermission(lang)));
			} else
				commandSender.sendMessage(TextComponent.fromLegacyText(messagesModule.getConsole(lang)));
		} else
			commandSender.sendMessage(TextComponent.fromLegacyText(messagesModule.getUnknown(lang)));
	}
}
