package dev._2lstudios.exploitfixer.bungee.listeners;

import dev._2lstudios.exploitfixer.bungee.exploit.BungeeExploitPlayer;
import dev._2lstudios.exploitfixer.bungee.managers.ExploitPlayerManager;
import dev._2lstudios.exploitfixer.bungee.managers.ModuleManager;
import dev._2lstudios.exploitfixer.shared.modules.NotificationsModule;
import dev._2lstudios.exploitfixer.shared.modules.PacketsModule;
import net.md_5.bungee.api.connection.Connection;
import net.md_5.bungee.api.connection.ProxiedPlayer;
import net.md_5.bungee.api.event.PluginMessageEvent;
import net.md_5.bungee.api.plugin.Listener;
import net.md_5.bungee.event.EventHandler;

public class PluginMessageListener implements Listener {
	private final PacketsModule packetsModule;
	private final ExploitPlayerManager exploitPlayerManager;
	private final NotificationsModule notificationsModule;

	PluginMessageListener(final ModuleManager moduleManager) {
		this.packetsModule = moduleManager.getPacketsModule();
		this.exploitPlayerManager = moduleManager.getExploitPlayerManager();
		this.notificationsModule = moduleManager.getNotificationsModule();
	}

	@EventHandler(priority = -128)
	public void onPluginMessage(final PluginMessageEvent event) {
		if (!event.isCancelled() && packetsModule.isEnabled()) {
			final Connection connection = event.getSender();

			if (connection instanceof ProxiedPlayer) {
				final ProxiedPlayer player = (ProxiedPlayer) connection;
				final BungeeExploitPlayer exploitPlayer = exploitPlayerManager.get(player);
				final String tag = event.getTag(), playerName = player.getName();
				final double tagVls = packetsModule.getTagVls(), dataVls = packetsModule.getDataVls();

				if (tagVls > 0 && tag == null || tag.isEmpty()) {
					notificationsModule.debug("[PacketPlayInCustomPayload|Tag] Sent by " + playerName
							+ " got cancelled because it doesn't have a TAG! Added vls: " + tagVls);

					event.setCancelled(true);
					exploitPlayer.addVls(event, player, packetsModule, tagVls);
					return;
				} else if (dataVls > 0) {
					final byte[] data = event.getData();
					final int byteLength = data.length;

					if (byteLength > packetsModule.getDataBytes()) {
						notificationsModule.debug("[PacketPlayInCustomPayload|Data] Sent by " + playerName
								+ " got cancelled because its " + byteLength + " bytes long! Added vls: " + dataVls);

						event.setCancelled(true);
						exploitPlayer.addVls(event, player, packetsModule, dataVls);
						return;
					}
				}

				exploitPlayer.addVls(event, player, packetsModule, packetsModule.getMultiplier(tag));
			}
		}
	}
}
