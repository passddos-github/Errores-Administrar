package dev._2lstudios.exploitfixer.shared.modules;

import java.io.File;
import java.util.Collection;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.logging.Logger;

import dev._2lstudios.exploitfixer.shared.configuration.IConfiguration;
import dev._2lstudios.exploitfixer.shared.interfaces.IConfigurationUtil;
import dev._2lstudios.exploitfixer.shared.interfaces.IMessagesModule;
import dev._2lstudios.exploitfixer.shared.interfaces.IModule;

public class MessagesModule implements IMessagesModule {
    private static final String NOTFOUND_STRING = "<STRING_NOT_FOUND> (Reset ExploitFixer locale folder)";
    private final IConfigurationUtil configurationUtil;
    private final Logger logger;
    private final String version;
    private final Map<String, Map<String, String>> locales = new HashMap<>();
    private final Collection<String> defaultLocales = new HashSet<>();
    private String web;
    private String defaultLocale;

    public MessagesModule(final IConfigurationUtil configurationUtil, final Logger logger, final String version) {
        this.configurationUtil = configurationUtil;
        this.logger = logger;
        this.version = version;

        defaultLocales.add("en");
        defaultLocales.add("es");
        defaultLocales.add("fr");
        defaultLocales.add("hu");
        defaultLocales.add("it");
        defaultLocales.add("pt");
        defaultLocales.add("tr");
    }

    public void putSection(final IConfiguration langFile, final Map<String, String> locale, final String currentPath) {
        for (final String key : langFile.getKeys()) {
            final IConfiguration section = langFile.getSection(key);

            if (section != null) {
                if (currentPath.isEmpty()) {
                    putSection(section, locale, key);
                } else {
                    putSection(section, locale, currentPath + "." + key);
                }
            } else {
                if (currentPath.isEmpty()) {
                    locale.put(key, langFile.getString(key));
                } else {
                    locale.put(currentPath + "." + key, langFile.getString(key));
                }
            }
        }
    }

    public void reload(final IConfiguration configYml, final File localeFolder) {
        web = configYml.getStringOrDefault("web", "<WEB_NOT_FOUND> (Reset ExploitFixer config file)");
        defaultLocale = configYml.getStringOrDefault("locale", "en").toLowerCase();

        for (final String locale : defaultLocales) {
            configurationUtil.create("%datafolder%/locales/" + locale + ".yml", "locales/" + locale + ".yml");
        }

        for (final File file : localeFolder.listFiles()) {
            final String fileName = file.getName();

            try {
                final IConfiguration langFile = configurationUtil.get(file.toPath().toString());
                final Map<String, String> locale = new HashMap<>();

                putSection(langFile, locale, "");

                locales.put(fileName.substring(0, 2).toLowerCase(), locale);
            } catch (final Exception ex) {
                logger.info(
                        "Wasn't able to load locale " + fileName + " because of a " + ex.getClass().getName() + "!");
            }
        }
    }

    public boolean isEnabled() {
        return true;
    }

    public String getName() {
        return "Messages";
    }

    @Override
    public String getString(final String locale, final String path) {
        final String string;

        if (locales.containsKey(locale)) {
            string = locales.get(locale).getOrDefault(path, NOTFOUND_STRING);
        } else if (locales.containsKey(defaultLocale)) {
            string = locales.get(defaultLocale).getOrDefault(path, NOTFOUND_STRING);
        } else {
            string = NOTFOUND_STRING;
        }

        return string.replace("%version%", version).replace("%web%", web).replace('&', '\u00a7');
    }

    public final String getReload(final String locale) {
        return getString(locale, "commands.reload");
    }

    public final String getHelp(final String locale) {
        return getString(locale, "commands.help");
    }

    public final String getUnknown(final String locale) {
        return getString(locale, "commands.error.unknown");
    }

    public final String getPermission(final String locale) {
        return getString(locale, "commands.error.permission");
    }

    public final String getConsole(final String locale) {
        return getString(locale, "commands.error.console");
    }

    public final String getEnable(final String locale) {
        return getString(locale, "commands.notifications.enable");
    }

    public final String getDisable(final String locale) {
        return getString(locale, "commands.notifications.disable");
    }

    public final String getKickMessage(final IModule module, final String locale) {
        return getString(locale, "modules." + module.getName().toLowerCase() + ".kick_message");
    }

    public final String getKickMessage(final String module, final String locale) {
        return getString(locale, "modules." + module.toLowerCase() + ".kick_message");
    }

    public String getStats(final String locale) {
        return getString(locale, "commands.stats");
    }

    public String getMojangDown(final String locale) {
        return getString(locale, "mojang_down");
    }
}